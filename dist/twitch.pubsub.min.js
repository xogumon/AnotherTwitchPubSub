(()=>{"use strict";const e={arrayLowerCase:e=>e.map((e=>e.toLowerCase())),repeat(e,t){let n=[];for(let s=0;s<t;s++)n.push(e());return n},nonce(){return this.repeat((()=>Math.random().toString(36).substring(2,15)),2).join("")},slug:(e,t="-")=>"string"!=typeof e?"":("string"!=typeof t&&(t="-"),e=e.toLowerCase().replace(/[^a-z0-9]/g,t),t.length>0&&(e=e.replace(new RegExp(`${t}{2,}`,"g"),t).replace(new RegExp(`^${t}|${t}$`,"g"),"")),e),removeDuplicates:e=>e.filter(((t,n)=>e.indexOf(t)===n))};var t=function(e,t,n,s){return new(n||(n=Promise))((function(i,o){function r(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};window.AnotherTwitchPubSub=class{constructor(t){if(this._events={},this._options={channelId:"",authToken:"",autoConnect:!0,autoReconnect:!0,reconnectAttempts:10,reconnectInterval:1e3,topics:[]},this._reconnectAttempts=0,this._pingTimestamp=0,this._latency=0,this._heartbeatTimeout=6e4,this._options=Object.assign({},this._options,t),this._options.topics=e.arrayLowerCase(this._options.topics),void 0===this._options.channelId||void 0===this._options.authToken||void 0===this._options.topics||0===this._options.topics.length||this._options.topics.length>50||this._options.topics.some((e=>"string"!=typeof e)))throw new Error("Invalid options");return this._options.autoConnect&&this._connect(),this.on("connected",this._subscribe.bind(this,this._options.topics))}_heartbeat(){var e;"open"===this.state()?(null===(e=this._client)||void 0===e||e.send(JSON.stringify({type:"PING"})),this._pingTimestamp=Date.now(),this._emit("ping","Ping sent"),clearTimeout(this._heartbeatTimer),this._heartbeatTimer=setTimeout(this._heartbeat.bind(this),this._heartbeatTimeout)):(this._latency=0,clearTimeout(this._heartbeatTimer))}_connect(){return t(this,void 0,void 0,(function*(){return yield new Promise(((e,t)=>{"closed"===this.state()?(this._client=new WebSocket("wss://pubsub-edge.twitch.tv"),this._client.onopen=this._clientOpen.bind(this),this._client.onclose=this._clientClose.bind(this),this._client.onerror=this._clientError.bind(this),this._client.onmessage=this._clientMessage.bind(this)):e(null),this.on("connected",(()=>{e(null)})).on("error",(e=>{e instanceof Error&&t(e)})).on("disconnected",(e=>{e.wasClean||t(e)}))})),this}))}_disconnect(){return t(this,void 0,void 0,(function*(){return yield new Promise((e=>{var t;"open"===this.state()?null===(t=this._client)||void 0===t||t.close(1e3,"Closed by user"):"closed"===this.state()&&e(null),this.on("disconnected",(()=>{e(null)}))})),this._client=void 0,this}))}_reconnect(){return t(this,void 0,void 0,(function*(){return yield new Promise(((e,t)=>{this._disconnect().then((()=>{this._reconnectAttempts++,this._reconnectAttempts<=this._options.reconnectAttempts?setTimeout(this._connect.bind(this),this._options.reconnectInterval):(this._reconnectAttempts=0,t(new Error("Reconnect attempts exceeded")))})),this.on("connected",(()=>{this._reconnectAttempts=0,e(null)})).on("error",(e=>{t(e)}))})),this}))}_send(e){return t(this,void 0,void 0,(function*(){return yield new Promise(((t,n)=>{var s;"open"===this.state()?t(null===(s=this._client)||void 0===s?void 0:s.send(JSON.stringify(e))):n(new Error("Not connected"))})),this}))}_subscribe(n){return t(this,void 0,void 0,(function*(){return yield new Promise(((t,s)=>{"open"!==this.state()?s(new Error("Not connected")):(Array.isArray(n)||(n=[n]),n=e.arrayLowerCase(n),(n=(n=e.removeDuplicates(n)).filter((e=>this._isValidTopic(e)))).length>0?this._send({type:"LISTEN",nonce:e.nonce(),data:{topics:n.map((e=>`${e}.${this._options.channelId}`)),auth_token:this._options.authToken}}).then((()=>{this._addTopics(n),t(null)})).catch((e=>{s(e)})):t(null))})),this}))}_unsubscribe(n){return t(this,void 0,void 0,(function*(){return yield new Promise(((t,s)=>{"open"!==this.state()?s(new Error("Not connected")):(Array.isArray(n)||(n=[n]),n=e.arrayLowerCase(n),(n=((n=(n=e.removeDuplicates(n)).filter((e=>this._isValidTopic(e))))||this._options.topics).map((e=>`${e}.${this._options.channelId}`))).length>0?this._send({type:"UNLISTEN",nonce:e.nonce(),data:{topics:n,auth_token:this._options.authToken}}).then((()=>{this._removeTopics(n),t(null)})).catch((e=>{s(e)})):t(null))})),this}))}_clientOpen(){this._emit("connected")}_clientClose(e){!e.wasClean&&this._options.autoReconnect&&this._reconnect();let t="";switch(e.code){case 1e3:t="Normal closure";break;case 1001:t="Going away";break;case 1002:t="Protocol error";break;case 1003:t="Unsupported data";break;case 1006:t="Abnormal closure";break;case 1007:t="Invalid data";break;case 1008:t="Policy violation";break;case 1009:t="Message too big";break;case 1010:t="Mandatory extension";break;case 1011:t="Internal server error";break;default:t="Unknown error"}clearTimeout(this._heartbeatTimer),this._emit("disconnected",{message:t,reason:e.reason,code:e.code})}_clientMessage(e){const t=JSON.parse(e.data),{type:n,data:s}=t;switch(n){case"PONG":this._onPong();break;case"MESSAGE":this._onMessage(t);break;case"RESPONSE":this._onResponse(t);break;case"LISTEN":case"UNLISTEN":this._emit(n,s);case"RECONNECT":case"DISCONNECT":this._emit(n);break;default:this._onError(new Error(`Unknown message type: ${n}`))}}_clientError(e){this._onError(e.error)}_onError(e){e instanceof Error?this._emit("error",e.message):this._emit("error",e)}_onMessage(e){this._emit("message",e);const{topic:t,message:n}=e.data;this._emit(t,JSON.parse(n));const{type:s,data:i}=JSON.parse(n),o=["channel-points-channel","channel-bits-events","channel-bits-badge-unlocks","channel-subscribe-events","whispers"].find((e=>t.includes(e)));switch(o){case"channel-points-channel":this._onChannelPointsEvent({type:s,data:i});break;case"channel-bits-events":case"channel-bits-badge-unlocks":this._onBitsEvent({type:o,data:i});break;case"channel-subscribe-events":this._onSubEvent(i);break;case"whispers":this._onWhisperEvent({type:i.type,data:e.data_object})}}_onResponse(e){let t;if(null==e?void 0:e.error){switch(e.error){case"ERR_BADAUTH":t="Invalid authentication token";break;case"ERR_BADTOPIC":t="Invalid topic";break;case"ERR_BADMESSAGE":t="Invalid message";break;case"ERR_SERVER":t="Server error";break;default:t="Unknown error"+e.error}this._onError(t)}else e&&this._emit("response",e),this._heartbeat()}_onPong(){clearTimeout(this._heartbeatTimer),this._heartbeatTimer=setTimeout(this._heartbeat.bind(this),this._heartbeatTimeout),this._latency=Date.now()-this._pingTimestamp,this._emit("pong",this._latency),this._latency>1e4?this._options.autoReconnect?this._reconnect():this._emit("warning",{message:"Latency is very high",latency:this._latency}):this._latency>1e3?this._emit("warning",{message:"Latency is high",latency:this._latency}):this._latency>100&&this._emit("warning",{message:"Latency is medium",latency:this._latency})}_onBitsEvent({type:e,data:t}){switch(e){case"channel-bits-events":this._emit("bits",t);break;case"channel-bits-badge-unlocks":this._emit("bitsbadge",t);break;default:this._onError(new Error(`Unknown message type: ${e}`))}}_onSubEvent(e){this._emit(e.context,{userId:e.user_id||null,userName:e.user_name||null,displayName:e.display_name||null,channelId:e.channel_id,channelName:e.channel_name,time:e.time,subPlan:e.sub_plan,subPlanName:e.sub_plan_name,isGift:e.is_gift||!1,months:e.months||null,cumulativeMonths:e.cumulative_months||null,streakMonths:e.streak_months||null,subMessage:e.sub_message||null,recipientId:e.recipient_id||null,recipientUserName:e.recipient_user_name||null,recipientDisplayName:e.recipient_display_name||null,multiMonthDuration:e.multi_month_duration||null})}_onWhisperEvent(e){this._emit(e.type,e.data)}_onChannelPointsEvent({type:e,data:t}){"reward-redeemed"===e?(this._emit("reward",t.redemption),this._emit(e,t.redemption)):this._emit(e,t)}_addTopics(e){return Array.isArray(e)||(e=[e]),e.forEach((e=>{this._options.topics.includes(e)||this._options.topics.push(e)})),this._options.topics}_removeTopics(e){return Array.isArray(e)||(e=[e]),this._options.topics=this._options.topics.filter((t=>!e.includes(t))),this._options.topics}_isValidTopic(e){try{const t=["channel-bits-events-v1","channel-bits-events-v2","channel-bits-badge-unlocks","channel-points-channel-v1","channel-subscribe-events-v1","chat-moderator-actions","automod-queue","user-moderation-notifications","whispers"];if("string"!=typeof e)throw new Error("Invalid topic");if(e.length>100)throw new Error("Topic is too long");return t.some((t=>e.toLowerCase().includes(t)))}catch(e){return!1}}_emit(t,...n){return t=e.slug(t),this._events.hasOwnProperty(t)&&this._events[t].forEach((e=>{e(...n)})),this}on(t,n){if(""===(t=e.slug(t)))throw new Error("Invalid event name");if("function"!=typeof n)throw new Error("Invalid callback");return this._events.hasOwnProperty(t)||(this._events[t]=[]),this._events[t].push(n),this}off(t,n){if(""===(t=e.slug(t)))throw new Error("Invalid event name");if("function"!=typeof n)throw new Error("Invalid callback");if(this._events.hasOwnProperty(t)){const e=this._events[t].indexOf(n);if(e>-1)return this._events[t].splice(e,1),this}return!1}connect(){if(this._options.autoConnect)throw new Error("autoConnect is enabled");return"open"!==this.state()?this._connect():Promise.resolve(this)}reconnect(){if(this._options.autoReconnect)throw new Error("autoReconnect is enabled");return this._reconnect()}disconnect(){return this._disconnect()}lastLatency(){return this._latency}subscribe(e){return this._subscribe(e)}unsubscribe(e){return this._unsubscribe(e)}registeredTopics(){return this._options.topics||[]}registeredTopicsCount(){return this.registeredTopics().length}isRegisteredTopic(e){return this.registeredTopics().includes(e)}state(){const{readyState:e}=this._client||{};switch(e){case WebSocket.CONNECTING:return"connecting";case WebSocket.OPEN:return"open";case WebSocket.CLOSING:return"closing";case WebSocket.CLOSED:default:return"closed"}}}})();
//# sourceMappingURL=twitch.pubsub.min.js.map